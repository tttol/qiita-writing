---
title: 「ログイン成功後に毎回XXXを実行したい」をSpring Securityで実装する
tags:
  - Java
  - SpringBoot
  - SpringSecurity
private: false
updated_at: '2024-03-22T16:07:35+09:00'
id: f72d1619eed422c93bfe
organization_url_name: null
slide: false
ignorePublish: false
---
## ログイン成功後にXXXを実行したい
- ログイン成功後、ユーザー情報のログを出力したい
- ログイン成功後、〇〇を満たすユーザーはXXにリダイレクトしたい

こうした要望をSpring Securityを使って実装するための方法を紹介します。

私の調べた限り、`AuthenticationSuccessHandler`と`AuthenticationSuccessEvent`の2種類の実装方法が存在しました。

## versions
- Spring Boot 3.2.3
- Spring Security 6.2.2

## AuthenticationSuccessHandler
まずは`AuthenticationSuccessHandler`を継承したカスタムのハンドラクラスを作成します。
```java:CustomLoginSuccessHandler
@Component
public class CustomLoginSuccessHandler implements AuthenticationSuccessHandler {
    @Override
    public void onAuthenticationSuccess(final HttpServletRequest request, final HttpServletResponse response,
        final Authentication authentication) throws IOException, ServletException {
        response.sendRedirect("/");
    }
}
```

そして、Spring Securityでおなじみの`SecurityConfig`の`securityFilterChain`の中で`successHandler`メソッドを使って先ほどのハンドラをセットします。

```java:SecurityConfig.java
@Configuration
@EnableWebSecurity
@EnableMethodSecurity
@RequiredArgsConstructor
public class SecurityConfig {

    private final CustomLoginSuccessHandler customLoginSuccessHandler;

    @Bean
    public SecurityFilterChain securityFilterChain(final HttpSecurity http) throws Exception {
        http //
            .oauth2Login(oauth2Login -> oauth2Login//
                .loginPage("/oauth2/authorization") //
                .successHandler(customLoginSuccessHandler)//
            );
        return http.build();
    }
}
```

こうすることで、Spring Securityによる認証が成功した後に`successHandler`で指定した`customLoginSuccessHandler`の処理が呼び出されることになります。


## AuthenticationSuccessEvent
`AuthenticationSuccessEvent`はアプリケーションでの認証成功を検知し起動するイベントです。
認証失敗を検知する`AuthenticationFailureEvent`も存在します。


```java:AuthenticationEvents.java
@Component
@Slf4j
public class AuthenticationEvents {
    @EventListener
    public void onSuccess(AuthenticationSuccessEvent success) {
        log.info("Authentication is succeeded.");
    }
}
```

注意点として、`onSuccess`メソッドの中では`SecurityContextHolder.getContext().getAuthentication()`がnullを返します。
これは、SecurityContextHolderに認証オブジェクト（Authentication object）がセットされる前に`onSuccess`が呼ばれていることを意味しています。

また、`AuthenticationEvents`ではリダイレクトなどのHTTPレスポンスを直接いじるような処理は実装できず、そうした処理は`AuthenticationSuccessHandler`で実装するのがbetterです。

#### 参考

https://spring.pleiades.io/spring-security/reference/servlet/authentication/events.html
