---
title: 中間CA・ルートCA・SSL代理証明の整理
tags:
  - SSL証明書
  - ネットワークエンジニア
private: false
updated_at: '2025-02-16T06:07:36+09:00'
id: f48c3952544a80034d0a
organization_url_name: null
slide: false
ignorePublish: false
---
# 登場人物
- ブラウザ
    - クライアント側のWebブラウザ
    - ブラウザにはルート証明書がデフォルトでインストールされている
- サーバー
    - クライアントがアクセスしたいウェブサイト等
    - サーバーがHTTPS通信するためには、サーバーにSSL証明書をインストールする必要がある。/etc/conf.d/sslなどに配置する？
- 中間CA
    - サーバーのSSL証明書の正当性を保証する認証局
    - 例：AWSのACMを使って証明書を発行した場合サーバーと中間CAの間にACMが存在する。中間CAはAWSが管理する認証局となる。
- ルートCA
    - 中間CAの正当性を保証する。全てのCAの親。


# シーケンス
```mermaid
sequenceDiagram
    participant ブラウザ as ブラウザ
    participant サーバー as サーバー
    participant 中間CA as 中間証明書（Intermediate CA）
    participant ルートCA as ルート証明書（Root CA）

    ブラウザ->>サーバー: HTTPSリクエスト
    サーバー-->>ブラウザ: サーバー証明書と中間証明書を送信
    ブラウザ->>中間CA: サーバー証明書の署名を検証
    alt 中間証明書が信頼されている場合
        ブラウザ->>ルートCA: 中間証明書の署名を検証
        alt ルート証明書が信頼されている場合
            ブラウザ-->>ブラウザ: SSL証明書を信頼
        else ルート証明書が信頼されていない場合
            ブラウザ-->>ブラウザ: エラー（証明書が信頼できない）
        end
    else 中間証明書が信頼されていない場合
        ブラウザ-->>ブラウザ: エラー（証明書チェーンが不完全）
    end
```

# SSL代理証明
- 企業ネットワークなどで、社員の通信を監視したいニーズが有る。しかしクライアント（社員）とサーバーの通信はSSLで暗号化されているため監視できない。
- クライアントとサーバーの間にプロキシサーバーを割り込ませる
- プロキシサーバーとサーバー間では通常通りのSSL通信を行う
- 企業用の独自のSSL証明書を発行し、クライアントとプロキシ間では独自SSL証明書を使った通信をさせる。クライアントにはあらかじめ独自SSL証明書を配布しインストールさせておく。
```mermaid
sequenceDiagram
    participant クライアント as クライアント（社員PC）
    participant プロキシ as SSLプロキシサーバー
    participant サーバー as 外部サーバー（例: https://example.com）

    クライアント->>プロキシ: HTTPSリクエストを送信 (https://example.com)
    プロキシ-->>クライアント: 独自のSSL証明書を提示
    クライアント-->>クライアント: SSL証明書を検証（企業のルート証明書を信頼）
    クライアント->>プロキシ: 暗号化通信を確立

    プロキシ->>サーバー: HTTPSリクエストを送信 (https://example.com)
    サーバー-->>プロキシ: サーバー証明書を提示
    プロキシ-->>プロキシ: サーバー証明書を検証

    プロキシ-->>サーバー: 暗号化通信を確立
    サーバー-->>プロキシ: サーバーからのデータを受信

    プロキシ-->>プロキシ: 通信内容を復号・解析
    プロキシ-->>クライアント: データを再暗号化して送信
    クライアント-->>クライアント: 受信データを復号して処理
```

# オレオレ証明書
- SSL証明書を自分で作成してサーバーにUPする。ルートCA・中間CAを使わない。
- 公開鍵も秘密鍵も自分で作成する
- 接続時に安全な接続ではないことをブラウザから警告を受ける
- ローカル環境・検証環境でSSLの設定が面倒なときや明らかに不要なときに用いる手段。
- 本番環境での利用はもちろんNG

# TLS相互認証
- サーバー証明書だけでなく、クライアント側の持つクライアント証明書の検証も実施する
```mermaid
sequenceDiagram
    participant クライアント
    participant サーバー
    participant 認証局 as 認証局（CA）

    クライアント->>サーバー: Client Hello (対応可能な暗号スイートを送信)
    サーバー->>クライアント: Server Hello (選択した暗号スイート, サーバー証明書を送信)
    サーバー->>認証局: サーバー証明書の検証
    認証局-->>サーバー: 証明書有効
    サーバー->>クライアント: クライアント証明書の要求
    クライアント->>認証局: サーバー証明書の検証
    認証局-->>クライアント: 証明書有効
    クライアント->>サーバー: クライアント証明書の送信, 証明書署名
    サーバー->>認証局: クライアント証明書の検証
    認証局-->>サーバー: 証明書有効
    サーバー->>クライアント: 認証完了 (セキュア通信確立)
    クライアント->>サーバー: 暗号化されたデータ通信
```

# 参考
https://qiita.com/miyuki_samitani/items/b19aa5ac3b3c6e312bd5

https://speakerdeck.com/minorun365/zheng-ming-shu-tutehe-datuke-awsnozhong-jian-cayi-xing-nibei-eru

https://www.cloudflare.com/ja-jp/learning/access-management/what-is-mutual-tls/
